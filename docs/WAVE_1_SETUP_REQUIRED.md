# Wave 1 Services Setup Guide

We have introduced several powerful third-party tools during the Wave 1 implementation phase to achieve native performance, global image CDN delivery, and robust error tracking.

If you are setting up this repository on a fresh machine or a new deployment environment, you must configure the following environment variables.

---

## 1. Cloudflare R2 (Image CDN)
We replaced the default Convex Storage with Cloudflare R2 to dramatically reduce egress costs and improve image loading speeds globally.

**Required in `.env` / Hosting Provider:**
```env
R2_ACCOUNT_ID=your-cloudflare-account-id
R2_ACCESS_KEY_ID=your-r2-access-key-id
R2_SECRET_ACCESS_KEY=your-r2-secret-access-key
R2_BUCKET_NAME=your-r2-bucket-name
R2_PUBLIC_URL=https://pub-yourcustomr2domain.r2.dev
```

**Setup Steps:**
1. Go to your **Cloudflare Dashboard** -> **R2**.
2. Create a bucket (e.g., `g-matrix-images`).
3. Under the bucket settings, click **Settings** -> **Public Access** -> **Custom Domains** and link it to a subdomain (or use the provided `r2.dev` URL for dev).
4. Go back to the main R2 page -> **Manage R2 API Tokens**.
5. Create a token with **Object Read & Write** permissions specifically for your new bucket.

*Note: The frontend now directly uploads files to S3 pre-signed URLs generated by Convex, bypassing Convex's internal file storage entirely.*

---

## 2. Sentry (Observability & Error Tracking)
We integrated `@sentry/react` and `@sentry/capacitor` to catch unhandled frontend exceptions, broken React queries, and native crashes.

**Required in `.env` / Hosting Provider:**
```env
VITE_SENTRY_DSN=https://your-dsn-key@o000000.ingest.us.sentry.io/0000000
```

**Setup Steps:**
1. Go to [sentry.io](https://sentry.io) and create a free account.
2. Create a new project (select **React** or **Capacitor**).
3. Copy the providing **Client Key (DSN)**.
4. Paste it into your local `.env`.

*Note: The app will gracefully fallback to standard `console.error` if this variable is missing, so it isn't strictly necessary for localhost development.*

---

## 3. OneSignal (Push Notifications)
We deprecated the manual iOS APNs / Firebase device token handlers inside Convex and delegated it to the `@convex-dev/action-retrier` and OneSignal.

**Setup Steps:**
1. You **do not** need new backend environment variables for this if you are using the Capacitor SDK directly, as the device registration happens on the client.
2. Ensure you have followed the instructions in `docs/PUSH_NOTIFICATIONS_SETUP.md` to link your Apple Push Certificate (P8) to the OneSignal dashboard.
3. The Convex `action-retrier` simply triggers standard API calls. If the OneSignal REST API route limits the app, Convex will automatically throttle and retry the push notification via exponential backoff.

---

## 4. App Store Feature Flagging
If Apple or Google flags a specific feature (like anonymous upvoting) during their review process, you do **not** need to submit a brand new app binary to remove the feature.

**Setup Steps:**
1. Open the [Convex Dashboard](https://dashboard.convex.dev).
2. Go to the `settings` table.
3. Add a new document: `{ "key": "FLAG_ANON_VOTING", "value": false }`.
4. Our React hook `useFeatureFlag('FLAG_ANON_VOTING', false)` will instantly evaluate to `false` remotely, and the UI component will disappear for the App Store reviewer.
